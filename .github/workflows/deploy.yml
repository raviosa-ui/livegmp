name: Build and Deploy to DreamHost (FTPS via lftp)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (optional - safe even for plain HTML)
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Build site (skip if HTML only)
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build || echo "No build step"
            npm run export || echo "No export step"
          fi

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Upload via FTPS (lftp)
        env:
          HOST: ${{ secrets.DH_HOST }}
          USER: ${{ secrets.DH_USER }}
          PASS: ${{ secrets.DH_PASS }}
          PORT: ${{ secrets.DH_PORT }}
        run: |
          # Local directory to upload:
          # if you use Next.js export use "out" instead of "." (uncomment the next line)
          # LOCAL_DIR="out"
          LOCAL_DIR="."

          # Remote directory (must end with /). Adjust if your site directory is different.
          REMOTE_DIR="/home/${USER}/livegmp.in/"

          echo "Uploading $LOCAL_DIR -> ftps://$HOST:$PORT$REMOTE_DIR"

          # lftp mirror command:
          # -R : reverse (local -> remote)
          # --delete : remove remote files that no longer exist locally
          # -v : verbose
          # --parallel=2 : parallel transfers
          # set ftps:initial-prot '' ensures explicit TLS (AUTH TLS)
          # set ftp:ssl-force true forces TLS
          # set ftp:ssl-protect-data true protects data channel
          # set ssl:verify-certificate no disables certificate verification (useful behind some proxies). Remove to enforce cert check.
          lftp -u "$USER","$PASS" -p $PORT -e "\
            set ftp:ssl-force true; \
            set ftp:ssl-protect-data true; \
            set ftps:initial-prot ''; \
            set ssl:verify-certificate no; \
            set ftp:passive-mode true; \
            mirror -R --delete --verbose --parallel=2 $LOCAL_DIR $REMOTE_DIR; \
            quit" ftps://$HOST
